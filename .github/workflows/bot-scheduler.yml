name: Smart Study Bot Scheduler

on:
  schedule:
    # Bangladesh Time (UTC+6) to UTC conversion:
    # 8:00 AM BD = 2:00 AM UTC
    # 10:00 AM BD = 4:00 AM UTC
    # 12:00 PM BD = 6:00 AM UTC
    # 3:00 PM BD = 9:00 AM UTC
    # 5:00 PM BD = 11:00 AM UTC
    # 7:00 PM BD = 1:00 PM UTC
    # 9:00 PM BD = 3:00 PM UTC
    
    - cron: '0 2 * * *'  # 8:00 AM BD Time
    - cron: '0 4 * * *'  # 10:00 AM BD Time
    - cron: '0 6 * * *'  # 12:00 PM BD Time
    - cron: '0 9 * * *'  # 3:00 PM BD Time
    - cron: '0 11 * * *' # 5:00 PM BD Time
    - cron: '0 13 * * *' # 7:00 PM BD Time
    - cron: '0 15 * * *' # 9:00 PM BD Time
  
  workflow_dispatch:  # Manual trigger
    inputs:
      time:
        description: 'Select run time (BDT)'
        required: false
        default: 'now'
        type: choice
        options:
        - '8:00 AM'
        - '10:00 AM'
        - '12:00 PM'
        - '3:00 PM'
        - '5:00 PM'
        - '7:00 PM'
        - '9:00 PM'

jobs:
  run-bot:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Create environment file
      run: |
        echo "BOT_TOKEN=${{ secrets.BOT_TOKEN }}" >> .env
        echo "CHANNEL_ID=${{ secrets.CHANNEL_ID }}" >> .env
        echo "DATABASE_URL=sqlite:///data/studybots.db" >> .env
        echo "LOG_LEVEL=INFO" >> .env
        
    - name: Create directories
      run: |
        mkdir -p data logs
        
    - name: Initialize database
      run: |
        python -c "
import sqlite3
conn = sqlite3.connect('data/studybots.db')
cursor = conn.cursor()
cursor.execute('''
CREATE TABLE IF NOT EXISTS questions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    class TEXT NOT NULL,
    subject TEXT NOT NULL,
    question TEXT NOT NULL,
    importance TEXT DEFAULT 'medium',
    marks INTEGER DEFAULT 5,
    chapter TEXT,
    posted_count INTEGER DEFAULT 0,
    last_posted DATE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(class, subject, question)
)
''')
cursor.execute('''
CREATE TABLE IF NOT EXISTS posted_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    question_id INTEGER NOT NULL,
    post_date DATE NOT NULL,
    post_time TIME NOT NULL,
    FOREIGN KEY (question_id) REFERENCES questions(id)
)
''')
conn.commit()
conn.close()
print('Database initialized')
"
        
    - name: Add sample questions
      run: |
        python -c "
import sqlite3
import json

conn = sqlite3.connect('data/studybots.db')
cursor = conn.cursor()

sample_questions = [
    ('class_11', 'physics', 'ржирж┐ржЙржЯржирзЗрж░ ржЧрждрж┐рж░ рж╕рзВрждрзНрж░ржЧрзБрж▓рзЛ ржмрж░рзНржгржирж╛ ржХрж░рзБржи', 'very_high', 10, 'ржмрж▓ ржУ ржЧрждрж┐'),
    ('class_11', 'chemistry', 'ржЖржмрзЗрж╢рзА ржУ ржЕржирж╛ржмрзЗрж╢рзА ржпрзМржЧрзЗрж░ ржкрж╛рж░рзНржержХрзНржп рж▓рж┐ржЦ', 'high', 8, 'рж░рж╛рж╕рж╛ржпрж╝ржирж┐ржХ ржмржирзНржзржи'),
    ('class_12', 'physics', 'рждржбрж╝рж┐рзО ржХрзНрж╖рзЗрждрзНрж░ ржУ ржЪрзБржорзНржмржХ ржХрзНрж╖рзЗрждрзНрж░рзЗрж░ рж╕ржорзНржкрж░рзНржХ ржмрзНржпрж╛ржЦрзНржпрж╛ ржХрж░', 'very_high', 15, 'рждржбрж╝рж┐рзОржЪрзБржорзНржмржХрждрзНржм'),
    ('college_year_1', 'calculus', 'Limit and continuity ржПрж░ рж╕ржВржЬрзНржЮрж╛ ржжрж╛ржУ', 'high', 10, 'Introduction'),
]

for q in sample_questions:
    cursor.execute('''
        INSERT OR IGNORE INTO questions 
        (class, subject, question, importance, marks, chapter)
        VALUES (?, ?, ?, ?, ?, ?)
    ''', q)

conn.commit()

# Check count
cursor.execute('SELECT COUNT(*) FROM questions')
count = cursor.fetchone()[0]
print(f'Total questions in database: {count}')

conn.close()
"
        
    - name: Run Smart Study Bot
      run: |
        python -c "
import os
import asyncio
import sys

# Add current directory to path
sys.path.append('.')

try:
    # Simple bot runner
    import telegram
    import schedule
    import time
    import sqlite3
    from datetime import datetime
    
    print('ЁЯдЦ Starting Smart Study Bot...')
    
    # Load environment
    BOT_TOKEN = os.getenv('BOT_TOKEN')
    CHANNEL_ID = os.getenv('CHANNEL_ID')
    
    if not BOT_TOKEN:
        print('тЭМ Error: BOT_TOKEN not found')
        sys.exit(1)
    
    print(f'тЬЕ Bot Token loaded')
    print(f'тЬЕ Channel: {CHANNEL_ID}')
    
    # Create a simple post
    bot = telegram.Bot(token=BOT_TOKEN)
    
    async def send_post():
        print('ЁЯФД Creating post...')
        current_time = datetime.now().strftime('%d %B, %Y %I:%M %p')
        
        post = f'''ЁЯУЪ *Smart Study Notes* ЁЯУЪ
========================

ЁЯОУ *CLASS 11-12 & COLLEGE*
========================

ЁЯУЦ *Physics:*
   1. ржирж┐ржЙржЯржирзЗрж░ ржЧрждрж┐рж░ рж╕рзВрждрзНрж░ржЧрзБрж▓рзЛ ржмрж░рзНржгржирж╛ ржХрж░рзБржи
      ЁЯУЪ ржЕржзрзНржпрж╛ржпрж╝: ржмрж▓ ржУ ржЧрждрж┐
      ЁЯУЭ ржиржорзНржмрж░: 10
      ЁЯФе *рззрзжрзж% ржкрж░рзАржХрзНрж╖рж╛ржпрж╝ ржЖрж╕ржмрзЗ*

ЁЯУЦ *Chemistry:*
   1. ржЖржмрзЗрж╢рзА ржУ ржЕржирж╛ржмрзЗрж╢рзА ржпрзМржЧрзЗрж░ ржкрж╛рж░рзНржержХрзНржп рж▓рж┐ржЦ
      ЁЯУЪ ржЕржзрзНржпрж╛ржпрж╝: рж░рж╛рж╕рж╛ржпрж╝ржирж┐ржХ ржмржирзНржзржи
      ЁЯУЭ ржиржорзНржмрж░: 8
      тнР *ржЦрзБржмржЗ ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг*

тП░ *ржкрзЛрж╕рзНржЯрзЗрж░ рж╕ржоржпрж╝:* {current_time}

ЁЯдЦ *ржмржЯрзЗрж░ ржмрж┐рж╢рзЗрж╖рждрзНржм:*
тАв рж╕рзНржмржпрж╝ржВржХрзНрж░рж┐ржпрж╝ ржкрзНрж░рж╢рзНржи ржкрзЛрж╕рзНржЯрж┐ржВ
тАв рззрзжрзж% ржкрж░рзАржХрзНрж╖рж╛рж░ ржЬржирзНржп ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг
тАв ржжрзИржирж┐ржХ рзн ржмрж╛рж░ ржЖржкржбрзЗржЯ

ЁЯУМ *ржЪрзНржпрж╛ржирзЗрж▓рзЗ ржпрзБржХрзНржд рж╣ржи:* @smartstudynotes11
ЁЯдЦ *ржмржЯ:* @smartstudy11bot
'''
        
        try:
            await bot.send_message(
                chat_id=CHANNEL_ID,
                text=post,
                parse_mode='Markdown',
                disable_web_page_preview=True
            )
            print('тЬЕ Post sent successfully!')
        except Exception as e:
            print(f'тЭМ Error sending post: {str(e)}')
    
    # Run once
    asyncio.run(send_post())
    
except Exception as e:
    print(f'тЭМ Error: {str(e)}')
    sys.exit(1)
"
        
    - name: Upload logs
      if: always()
      uses: actions/upload-artifact@v4  # Changed from v3 to v4
      with:
        name: bot-logs
        path: |
          logs/
        retention-days: 7
        
    - name: Check database
      run: |
        if [ -f "data/studybots.db" ]; then
          echo "тЬЕ Database file exists"
          ls -la data/
        else
          echo "тЭМ Database file not found"
        fi
